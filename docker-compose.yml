version: "3.8"

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - TZ=Europe/Berlin
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8ndb}
      - DB_POSTGRESDB_USER=${N8N_DB_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-change_me}
      - N8N_DIAGNOSTICS_ENABLED=false
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      n8n-db:
        condition: service_healthy
    networks:
      - asi

  n8n-db:
    image: postgres:16-alpine
    container_name: n8n-db
    restart: unless-stopped
    environment:
      - TZ=Europe/Berlin
      - POSTGRES_DB=${N8N_DB_NAME:-n8ndb}
      - POSTGRES_USER=${N8N_DB_USER:-n8n}
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD:-change_me}
    volumes:
      - n8n_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_DB_USER:-n8n} -d ${N8N_DB_NAME:-n8ndb}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - asi

  youtrack:
    image: jetbrains/youtrack:2025.3.112453
    container_name: youtrack
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - TZ=Europe/Berlin
    volumes:
      - youtrack_data:/opt/youtrack/data
      - youtrack_conf:/opt/youtrack/conf
      - youtrack_logs:/opt/youtrack/logs
      - youtrack_backups:/opt/youtrack/backups
    networks:
      - asi
  confluence:
    container_name: confluence
    image: atlassian/confluence:9.2.4
    depends_on:
      - confluence-db
    ports:
      - "8090:8090"
    volumes:
      - confluence_db_data:/var/confluence
    restart: always
    networks:
      - asi

  confluence-db:
    container_name: confluence-db
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=${CONFLUENCE_DB_NAME:-confluence}
      - POSTGRES_PASSWORD=${CONFLUENCE_DB_PASSWORD:-change_me}
      - POSTGRES_DB=${CONFLUENCE_DB_NAME:-confluence}
    volumes:
      - confluence_db_data:/var/lib/postgresql/data
    restart: always
    ports:
      - "5433:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${CONFLUENCE_DB_USER:-confluence} -d ${CONFLUENCE_DB_NAME:-confluence}" ]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - asi

  confluence-mcp-server:
    container_name: confluence-mcp-server
    build:
      dockerfile: Dockerfile
      context: ./confluence-mcp-server
      network: host
    environment:
      - CONFLUENCE_URL=http://confluence:8090/rest/api
      - CONFLUENCE_USERNAME=${CONFLUENCE_USERNAME}
      - CONFLUENCE_API_TOKEN=${CONFLUENCE_API_TOKEN}
      - SERVER_PORT=8084
    restart: always
    ports:
      - "8084:8084"
    depends_on:
      - confluence
    networks:
      - asi

  documentation-agent-client:
    container_name: documentation-agent-client
    build:
      dockerfile: Dockerfile
      context: ./documentation-agent-client
      network: host
    environment:
      - CONFLUENCE_MCP_SERVER_URL=http://confluence-mcp-server:8084
      - PM_MCP_SERVER_URL=http://project-manager-client:9091
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERVER_PORT=9095
    restart: always
    ports:
      - "9095:9095"
    depends_on:
      - confluence-mcp-server
    networks:
      - asi

  project-manager-client:
    container_name: project-manager-client
    build:
      dockerfile: Dockerfile
      context: ./project-manager-client
      network: host
    environment:
      - YOUTRACK_MCP_SERVER_URL=http://youtrack-mcp-server:8082
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERVER_PORT=9091
    restart: always
    ports:
      - "9091:9091"
    depends_on:
      - youtrack-mcp-server
    networks:
      - asi

  coordinator:
    container_name: coordinator
    build:
      dockerfile: Dockerfile
      context: ./coordinator
      network: host
    environment:
      - PM_MCP_SERVER_URL=http://project-manager-client:9091
      - DOCUMENTATION_AGENT_MCP_SERVER_URL=http://documentation-agent-client:9095
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERVER_PORT=9099
    restart: always
    ports:
      - "9099:9099"
    depends_on:
      - youtrack-mcp-server
      - project-manager-client
      - confluence-mcp-server
      - documentation-agent-client
    networks:
      - asi

  youtrack-mcp-server:
    container_name: youtrack-mcp-server
    build:
      dockerfile: Dockerfile
      context: ./youtrack-mcp-server
      network: host
    environment:
      - YOUTRACK_URL=http://youtrack:8080
      - YOUTRACK_TOKEN=${YOUTRACK_TOKEN}
      - SERVER_PORT=8082
    restart: always
    ports:
      - "8082:8082"
    depends_on:
      - youtrack
    networks:
      - asi
  github-mcp-server:
    image: ghcr.io/github/github-mcp-server:latest
    container_name: github-mcp
    environment:
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}
      GITHUB_TOOLS: list_pull_requests,pull_request_read,pull_request_review_write,get_commit,get_file_contents,list_branches,search_code,search_repositories
    restart: always
    ports:
      - "8086:8086"
    networks:
      - asi

  telegram-mcp:
    image: oswaldslabbert/telegram-mcp:latest
    container_name: telegram-mcp
    environment:
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
      TELEGRAM_SESSION_STRING: ${TELEGRAM_SESSION_STRING}
    restart: always
    ports:
      - "7090:7090"
    networks:
      - asi

  prometheus:
    image: prom/prometheus:v3.9.1
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - project-manager-client
      - youtrack-mcp-server
    networks:
      - asi

  grafana:
    image: grafana/grafana:12.3.1
    container_name: grafana
    environment:
        GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
        GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - asi

  redis:
    image: redis:8.4-alpine
    container_name: redis
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped
    networks:
      - asi

networks:
  asi:
    driver: bridge

volumes:
  n8n_data:
  n8n_db_data:
  youtrack_data:
  youtrack_conf:
  youtrack_logs:
  youtrack_backups:
  confluence_db_data:
